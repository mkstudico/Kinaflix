<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Teasers | KINAFLIX</title>
  <meta name="description" content="Manage short movies on KINAFLIX.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
  <style>
    :root {
      --primary: #e50914;
      --primary-dark: #b2070f;
      --dark: #141414;
      --light: #f4f4f4;
      --gray: #999;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      --sidebar-width: 80px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--dark);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border-right: 1px solid var(--primary);
    }
    .sidebar a, .sidebar button {
      color: var(--light);
      font-size: 1.5rem;
      margin: 1rem 0;
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s;
    }
    .sidebar a:hover, .sidebar button:hover {
      color: var(--primary);
    }
    .sidebar .active {
      color: var(--primary);
    }
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 2rem;
    }
    .container {
      background: var(--dark);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--primary);
      margin-bottom: 1.5rem;
    }
    .title {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    .form-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-section input,
    .form-section textarea,
    .form-section select {
      padding: 0.5rem;
      border: 1px solid var(--gray);
      border-radius: 4px;
      background: #222;
      color: var(--light);
      font-size: 0.9rem;
    }
    .form-section input[type="file"] {
      padding: 0.2rem;
    }
    .form-section button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.7rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    .form-section button:hover {
      background: var(--primary-dark);
    }
    .form-section button:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--dark);
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      position: relative;
      border: 1px solid var(--primary);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: var(--primary);
    }
    .confirmation-modal {
      text-align: center;
    }
    .confirmation-modal button {
      margin: 0.5rem;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .loading-overlay.active {
      display: flex;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner {
      display: none;
      width: 30px;
      height: 30px;
      margin: 1rem auto;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner.active {
      display: block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--dark);
      color: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success {
      background: #4CAF50;
    }
    .toast.error {
      background: #f44336;
    }
    .trailers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .trailer-card {
      cursor: pointer;
      transition: transform 0.3s;
    }
    .trailer-card:hover {
      transform: scale(1.05);
    }
    .trailer-poster {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
    }
    .trailer-title {
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .link-type-selector {
      display: flex;
      margin-bottom: 0.5rem;
    }
    .link-type-selector button {
      flex: 1;
      background: #333;
      border: 1px solid var(--gray);
      padding: 0.5rem;
      cursor: pointer;
    }
    .link-type-selector button.active {
      background: var(--primary);
      border-color: var(--primary);
    }
    .link-type-selector button:first-child {
      border-radius: 4px 0 0 4px;
    }
    .link-type-selector button:last-child {
      border-radius: 0 4px 4px 0;
    }
    .search-bar {
      position: relative;
      margin-bottom: 1rem;
    }
    .search-bar input {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 1rem;
      background: #222;
      color: var(--light);
      border: 1px solid var(--gray);
      border-radius: 4px;
    }
    .search-bar i {
      position: absolute;
      right: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 0.9rem;
    }
    .watch-button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.3rem 0.6rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.7rem;
      margin-top: 0.3rem;
      transition: background 0.3s;
    }
    .watch-button:hover {
      background: var(--primary-dark);
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: 60px;
        top: auto;
        bottom: 0;
        flex-direction: row;
        justify-content: space-around;
        border-right: none;
        border-top: 1px solid var(--primary);
      }
      .main-content {
        margin-left: 0;
        margin-bottom: 60px;
        padding: 1rem;
      }
      .container {
        padding: 1rem;
      }
      .trailers-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
    @media (max-width: 576px) {
      .title {
        font-size: 1.2rem;
      }
      .form-section input,
      .form-section textarea,
      .form-section select,
      .form-section button {
        font-size: 0.85rem;
      }
      .trailers-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .trailer-poster {
        height: 80px;
      }
      .trailer-title {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="#" class="add-teaser active"><i class="fas fa-plus"></i></a>
    <a href="#" class="view-teasers"><i class="fas fa-video"></i></a>
  </div>
  <div class="main-content">
    <div class="container add-teaser-section">
      <h1 class="title">Add Teaser</h1>
      <div class="container">
        <h2 class="title">Short Movie</h2>
        <form id="movie-form" class="form-section">
          <input type="text" id="movie-title" placeholder="Movie Title" required>
          <div class="link-type-selector">
            <button type="button" id="gdrive-btn">Google Drive</button>
            <button type="button" id="imdb-btn" class="active">IMDB ID</button>
          </div>
          <input type="text" id="movie-link" placeholder="IMDB ID (e.g. tt1234567)" required>
          <input type="file" id="movie-poster" accept="image/*">
          <textarea id="movie-description" placeholder="Description (Optional)" rows="4"></textarea>
          <button type="submit" id="add-movie-btn">Add Movie</button>
        </form>
        <div class="form-spinner" id="movie-spinner"></div>
      </div>
    </div>
    <div class="container view-teasers-section" style="display: none;">
      <h1 class="title">Short Movies</h1>
      <div class="search-bar">
        <input type="text" id="movie-search" placeholder="Search movies...">
        <i class="fas fa-search"></i>
      </div>
      <div class="trailers-grid" id="trailers-grid"></div>
      <div class="form-spinner" id="trailers-spinner"></div>
    </div>
  </div>
  <div class="modal" id="edit-movie-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Edit Movie</h2>
      <form id="edit-movie-form" class="form-section">
        <input type="hidden" id="edit-movie-id">
        <input type="text" id="edit-movie-title" placeholder="Movie Title" required>
        <div class="link-type-selector">
          <button type="button" id="edit-gdrive-btn">Google Drive</button>
          <button type="button" id="edit-imdb-btn" class="active">IMDB ID</button>
        </div>
        <input type="text" id="edit-movie-link" placeholder="IMDB ID (e.g. tt1234567)" required>
        <input type="file" id="edit-movie-poster" accept="image/*">
        <textarea id="edit-movie-description" placeholder="Description (Optional)" rows="4"></textarea>
        <button type="submit" id="edit-movie-btn">Update Movie</button>
        <button type="button" id="delete-movie-btn" style="background: #f44336;">Delete Movie</button>
      </form>
      <div class="form-spinner" id="edit-movie-spinner"></div>
    </div>
  </div>
  <div class="modal" id="confirm-delete-modal">
    <div class="modal-content confirmation-modal">
      <h2 class="title" id="confirm-title"></h2>
      <p id="confirm-message"></p>
      <button id="confirm-yes-btn" style="background: #f44336;">Yes</button>
      <button id="confirm-no-btn">No</button>
    </div>
  </div>
  <div class="modal" id="confirm-delete-again-modal">
    <div class="modal-content confirmation-modal">
      <h2 class="title">Confirm Again</h2>
      <p>Are you absolutely sure? This action cannot be undone.</p>
      <button id="confirm-again-yes-btn" style="background: #f44336;">Yes</button>
      <button id="confirm-again-no-btn">No</button>
    </div>
  </div>
  <div class="loading-overlay" id="initial-loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  <div class="toast" id="toast"></div>

  <!-- New Watch Modal for Fullscreen IMDB Videos -->
  <div class="modal" id="watch-modal">
    <div class="modal-content" style="max-width: 95%; width: 95%; height: 90%;">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title" id="watch-title">Watch Movie</h2>
      <div style="height: calc(100% - 80px);">
        <iframe 
          id="watch-iframe" 
          style="width: 100%; height: 100%; border: none; border-radius: 8px;" 
          src="" 
          frameborder="0" 
          allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; fullscreen" 
          allowfullscreen>
        </iframe>
      </div>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
      authDomain: "kinaflix.firebaseapp.com",
      databaseURL: "https://kinaflix-default-rtdb.firebaseio.com",
      projectId: "kinaflix",
      storageBucket: "kinaflix.firebasestorage.app",
      messagingSenderId: "318239806217",
      appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8",
      measurementId: "G-DC1T9B6B9W"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);

    // DOM Elements
    const addTeaserSection = document.querySelector('.add-teaser-section');
    const viewTeasersSection = document.querySelector('.view-teasers-section');
    const addTeaserLink = document.querySelector('.add-teaser');
    const viewTeasersLink = document.querySelector('.view-teasers');
    const movieForm = document.getElementById('movie-form');
    const editMovieForm = document.getElementById('edit-movie-form');
    const trailersGrid = document.getElementById('trailers-grid');
    const movieSearch = document.getElementById('movie-search');
    const editMovieModal = document.getElementById('edit-movie-modal');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const confirmDeleteAgainModal = document.getElementById('confirm-delete-again-modal');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const movieSpinner = document.getElementById('movie-spinner');
    const editMovieSpinner = document.getElementById('edit-movie-spinner');
    const trailersSpinner = document.getElementById('trailers-spinner');
    const toast = document.getElementById('toast');
    const gdriveBtn = document.getElementById('gdrive-btn');
    const imdbBtn = document.getElementById('imdb-btn');
    const movieLinkInput = document.getElementById('movie-link');
    const editGdriveBtn = document.getElementById('edit-gdrive-btn');
    const editImdbBtn = document.getElementById('edit-imdb-btn');
    const editMovieLinkInput = document.getElementById('edit-movie-link');
    const watchModal = document.getElementById('watch-modal');
    const watchIframe = document.getElementById('watch-iframe');
    const watchTitle = document.getElementById('watch-title');

    // Global Variables
    let trailers = [];
    let deleteTarget = null;
    let deleteType = null;
    let currentLinkType = 'imdb'; // Set IMDB as default
    let editCurrentLinkType = 'imdb'; // Set IMDB as default

    // Embed sources for IMDB movies
    const embedSources = [
      { name: 'vidsrc', url: (imdbId) => `https://vidsrc.me/embed/${imdbId}` },
      { name: '2embed', url: (imdbId) => `https://www.2embed.cc/embed/${imdbId}` },
      { name: 'wootly', url: (imdbId) => `https://wootly.ch/embed/${imdbId}` }
    ];

    // Initialize the application
    document.addEventListener('DOMContentLoaded', () => {
      initialLoadingOverlay.classList.add('active');
      loadTrailers().then(() => {
        initialLoadingOverlay.classList.remove('active');
      });

      // Link type selector for add movie form
      gdriveBtn.addEventListener('click', () => {
        currentLinkType = 'gdrive';
        gdriveBtn.classList.add('active');
        imdbBtn.classList.remove('active');
        movieLinkInput.placeholder = 'Google Drive Link';
        movieLinkInput.type = 'url';
      });

      imdbBtn.addEventListener('click', () => {
        currentLinkType = 'imdb';
        imdbBtn.classList.add('active');
        gdriveBtn.classList.remove('active');
        movieLinkInput.placeholder = 'IMDB ID (e.g. tt1234567)';
        movieLinkInput.type = 'text';
      });

      // Link type selector for edit movie form
      editGdriveBtn.addEventListener('click', () => {
        editCurrentLinkType = 'gdrive';
        editGdriveBtn.classList.add('active');
        editImdbBtn.classList.remove('active');
        editMovieLinkInput.placeholder = 'Google Drive Link';
        editMovieLinkInput.type = 'url';
      });

      editImdbBtn.addEventListener('click', () => {
        editCurrentLinkType = 'imdb';
        editImdbBtn.classList.add('active');
        editGdriveBtn.classList.remove('active');
        editMovieLinkInput.placeholder = 'IMDB ID (e.g. tt1234567)';
        editMovieLinkInput.type = 'text';
      });

      // Navigation
      addTeaserLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTeaserSection.style.display = 'block';
        viewTeasersSection.style.display = 'none';
        addTeaserLink.classList.add('active');
        viewTeasersLink.classList.remove('active');
      });

      viewTeasersLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTeaserSection.style.display = 'none';
        viewTeasersSection.style.display = 'block';
        addTeaserLink.classList.remove('active');
        viewTeasersLink.classList.add('active');
        loadTrailers();
      });

      // Modal controls
      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.modal').style.display = 'none';
        });
      });

      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.style.display = 'none';
        });
      });

      // Search functionality
      let movieSearchTimeout;
      movieSearch.addEventListener('input', () => {
        clearTimeout(movieSearchTimeout);
        movieSearchTimeout = setTimeout(() => {
          const query = movieSearch.value.trim().toLowerCase();
          renderTrailers(filterTrailers(query));
        }, 300);
      });

      // Form submissions
      movieForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('movie');
        try {
          const title = document.getElementById('movie-title').value.trim();
          const linkValue = document.getElementById('movie-link').value.trim();
          const description = document.getElementById('movie-description').value.trim();
          const posterFile = document.getElementById('movie-poster').files[0];

          if (!title || !linkValue) {
            showToast('Title and link are required', 'error');
            hideFormLoading('movie');
            return;
          }

          // Validate based on link type
          if (currentLinkType === 'gdrive') {
            if (!linkValue.includes('drive.google.com')) {
              showToast('Please provide a valid Google Drive link', 'error');
              hideFormLoading('movie');
              return;
            }
          } else if (currentLinkType === 'imdb') {
            if (!linkValue.startsWith('tt') || isNaN(linkValue.substring(2))) {
              showToast('Please provide a valid IMDB ID (e.g. tt1234567)', 'error');
              hideFormLoading('movie');
              return;
            }
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (!data.success) {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('movie');
              return;
            }
            posterUrl = data.data.url;
          }

          const movieData = {
            title,
            description: description || '',
            createdAt: new Date()
          };

          // Add the appropriate link field based on type
          if (currentLinkType === 'gdrive') {
            movieData.gdriveLink = linkValue;
          } else {
            movieData.imdbId = linkValue;
          }

          // Add poster URL if available
          if (posterUrl) {
            movieData.posterUrl = posterUrl;
          } else {
            movieData.posterUrl = 'https://via.placeholder.com/140x100?text=No+Image';
          }

          await addDoc(collection(db, 'trailers'), movieData);

          showToast('Movie added successfully', 'success');
          movieForm.reset();
          // Reset to IMDB as default after form submission
          currentLinkType = 'imdb';
          imdbBtn.classList.add('active');
          gdriveBtn.classList.remove('active');
          movieLinkInput.placeholder = 'IMDB ID (e.g. tt1234567)';
          movieLinkInput.type = 'text';
          await loadTrailers();
        } catch (error) {
          console.error('Error adding movie:', error);
          showToast('Error adding movie: ' + error.message, 'error');
        } finally {
          hideFormLoading('movie');
        }
      });

      editMovieForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('edit-movie');
        try {
          const movieId = document.getElementById('edit-movie-id').value;
          const title = document.getElementById('edit-movie-title').value.trim();
          const linkValue = document.getElementById('edit-movie-link').value.trim();
          const description = document.getElementById('edit-movie-description').value.trim();
          const posterFile = document.getElementById('edit-movie-poster').files[0];

          if (!title || !linkValue) {
            showToast('Title and link are required', 'error');
            hideFormLoading('edit-movie');
            return;
          }

          // Validate based on link type
          if (editCurrentLinkType === 'gdrive') {
            if (!linkValue.includes('drive.google.com')) {
              showToast('Please provide a valid Google Drive link', 'error');
              hideFormLoading('edit-movie');
              return;
            }
          } else if (editCurrentLinkType === 'imdb') {
            if (!linkValue.startsWith('tt') || isNaN(linkValue.substring(2))) {
              showToast('Please provide a valid IMDB ID (e.g. tt1234567)', 'error');
              hideFormLoading('edit-movie');
              return;
            }
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (!data.success) {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('edit-movie');
              return;
            }
            posterUrl = data.data.url;
          }

          const movieRef = doc(db, 'trailers', movieId);
          const updateData = {
            title,
            description: description || '',
            updatedAt: new Date()
          };

          // Update the appropriate link field based on type
          if (editCurrentLinkType === 'gdrive') {
            updateData.gdriveLink = linkValue;
            updateData.imdbId = ''; // Clear IMDB ID if switching to Google Drive
          } else {
            updateData.imdbId = linkValue;
            updateData.gdriveLink = ''; // Clear Google Drive link if switching to IMDB
          }

          // Add poster URL if available
          if (posterUrl) {
            updateData.posterUrl = posterUrl;
          }

          await updateDoc(movieRef, updateData);

          showToast('Movie updated successfully', 'success');
          editMovieModal.style.display = 'none';
          await loadTrailers();
        } catch (error) {
          console.error('Error updating movie:', error);
          showToast('Error updating movie: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit-movie');
        }
      });

      // Delete functionality
      document.getElementById('delete-movie-btn').addEventListener('click', () => {
        const movieId = document.getElementById('edit-movie-id').value;
        deleteTarget = movieId;
        deleteType = 'movie';
        showConfirmDeleteModal('Delete Movie', 'Are you sure you want to delete this movie?');
      });

      document.getElementById('confirm-yes-btn').addEventListener('click', () => {
        confirmDeleteModal.style.display = 'none';
        confirmDeleteAgainModal.style.display = 'flex';
      });

      document.getElementById('confirm-no-btn').addEventListener('click', () => {
        confirmDeleteModal.style.display = 'none';
        deleteTarget = null;
        deleteType = null;
      });

      document.getElementById('confirm-again-yes-btn').addEventListener('click', async () => {
        confirmDeleteAgainModal.style.display = 'none';
        showFormLoading('edit-movie');
        try {
          if (deleteType === 'movie') {
            const movieRef = doc(db, 'trailers', deleteTarget);
            await deleteDoc(movieRef);
            showToast('Movie deleted', 'success');
            editMovieModal.style.display = 'none';
            await loadTrailers();
          }
        } catch (error) {
          console.error('Error deleting:', error);
          showToast('Error deleting: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit-movie');
          deleteTarget = null;
          deleteType = null;
        }
      });

      document.getElementById('confirm-again-no-btn').addEventListener('click', () => {
        confirmDeleteAgainModal.style.display = 'none';
        deleteTarget = null;
        deleteType = null;
      });

      // Edit movie modal
      trailersGrid.addEventListener('click', (e) => {
        const trailerCard = e.target.closest('.trailer-card');
        if (trailerCard && !e.target.classList.contains('watch-button')) {
          const trailerId = trailerCard.dataset.id;
          const trailer = trailers.find(t => t.id === trailerId);
          document.getElementById('edit-movie-id').value = trailerId;
          document.getElementById('edit-movie-title').value = trailer.title;
          
          // Set the appropriate link type and value
          if (trailer.imdbId) {
            editCurrentLinkType = 'imdb';
            editImdbBtn.classList.add('active');
            editGdriveBtn.classList.remove('active');
            editMovieLinkInput.placeholder = 'IMDB ID (e.g. tt1234567)';
            editMovieLinkInput.type = 'text';
            editMovieLinkInput.value = trailer.imdbId;
          } else {
            editCurrentLinkType = 'gdrive';
            editGdriveBtn.classList.add('active');
            editImdbBtn.classList.remove('active');
            editMovieLinkInput.placeholder = 'Google Drive Link';
            editMovieLinkInput.type = 'url';
            editMovieLinkInput.value = trailer.gdriveLink || '';
          }
          
          document.getElementById('edit-movie-description').value = trailer.description || '';
          editMovieModal.style.display = 'flex';
        }
      });
    });

    // Data functions
    async function loadTrailers() {
      showFormLoading('trailers');
      try {
        const q = query(collection(db, 'trailers'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        trailers = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderTrailers(trailers);
      } catch (error) {
        console.error('Error loading trailers:', error);
        showToast('Error loading trailers: ' + error.message, 'error');
      } finally {
        hideFormLoading('trailers');
      }
    }

    function renderTrailers(trailersToRender) {
      trailersGrid.innerHTML = trailersToRender.length > 0 ? trailersToRender.map(trailer => `
        <div class="trailer-card" data-id="${trailer.id}">
          <img src="${trailer.posterUrl}" alt="${trailer.title}" class="trailer-poster" loading="lazy">
          <h3 class="trailer-title">${trailer.title}</h3>
          ${trailer.imdbId ? `<button class="watch-button" data-id="${trailer.id}"><i class="fas fa-play"></i> Watch</button>` : ''}
        </div>
      `).join('') : '<p>No movies found.</p>';

      // Add event listeners to watch buttons
      document.querySelectorAll('.watch-button').forEach(button => {
        button.addEventListener('click', (e) => {
          e.stopPropagation();
          const trailerId = button.dataset.id;
          const trailer = trailers.find(t => t.id === trailerId);
          if (trailer && trailer.imdbId) {
            openWatchModal(trailer);
          }
        });
      });
    }

    function openWatchModal(trailer) {
      watchTitle.textContent = `Watch: ${trailer.title}`;
      
      // Try embed sources in order
      let currentSourceIndex = 0;
      
      function tryNextSource() {
        if (currentSourceIndex >= embedSources.length) {
          showToast('Failed to load video from all sources', 'error');
          return;
        }
        
        const source = embedSources[currentSourceIndex];
        const embedUrl = source.url(trailer.imdbId);
        
        watchIframe.src = embedUrl;
        watchIframe.onload = () => {
          showToast(`Loaded from ${source.name}`, 'success');
        };
        
        watchIframe.onerror = () => {
          currentSourceIndex++;
          setTimeout(tryNextSource, 500);
        };
      }
      
      watchModal.style.display = 'flex';
      tryNextSource();
    }

    function filterTrailers(query) {
      if (!query) return trailers;
      return trailers.filter(trailer => {
        const descriptionMatch = trailer.description?.toLowerCase().includes(query);
        const titleMatch = trailer.title.toLowerCase().includes(query);
        return descriptionMatch || titleMatch;
      }).sort((a, b) => {
        const aDescriptionMatch = a.description?.toLowerCase().includes(query) ? 1 : 0;
        const bDescriptionMatch = b.description?.toLowerCase().includes(query) ? 1 : 0;
        return bDescriptionMatch - aDescriptionMatch;
      });
    }

    // UI helper functions
    function showConfirmDeleteModal(title, message) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-message').textContent = message;
      confirmDeleteModal.style.display = 'flex';
    }

    function showToast(message, type = 'info') {
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showFormLoading(formType) {
      if (formType === 'movie') {
        movieSpinner.classList.add('active');
        document.getElementById('add-movie-btn').disabled = true;
        movieForm.style.opacity = '0.6';
      } else if (formType === 'edit-movie') {
        editMovieSpinner.classList.add('active');
        document.getElementById('edit-movie-btn').disabled = true;
        editMovieForm.style.opacity = '0.6';
      } else if (formType === 'trailers') {
        trailersSpinner.classList.add('active');
        trailersGrid.style.opacity = '0.6';
      }
    }

    function hideFormLoading(formType) {
      if (formType === 'movie') {
        movieSpinner.classList.remove('active');
        document.getElementById('add-movie-btn').disabled = false;
        movieForm.style.opacity = '1';
      } else if (formType === 'edit-movie') {
        editMovieSpinner.classList.remove('active');
        document.getElementById('edit-movie-btn').disabled = false;
        editMovieForm.style.opacity = '1';
      } else if (formType === 'trailers') {
        trailersSpinner.classList.remove('active');
        trailersGrid.style.opacity = '1';
      }
    }
  </script>
</body>
</html>
