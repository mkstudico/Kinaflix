<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loading... | KINAFLIX</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    /* Your existing CSS styles remain the same */
    :root {
      --primary: #e50914;
      --ad-primary: #4285f4;
      --dark: #000000;
      --light: #f5f5f5;
      --gray-text: #888;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--dark);
      color: var(--light);
      height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background-color: #f40612;
    }

    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .video-container iframe,
    .video-container div[id^="rumble_"] {
      width: 100%;
      height: 100%;
      border: none;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      gap: 1rem;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: white;
      font-size: 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Rest of your CSS styles remain unchanged */
  </style>
</head>
<body>
  <a href="#" class="back-button" id="back-button">
    <i class="fas fa-arrow-left"></i>
    <span>BACK</span>
  </a>

  <div class="video-container" id="video-container">
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading player...</div>
    </div>
  </div>

  <script type="module">
    // Configuration
    const RUMBLE_PUB_ID = '4m9tqz'; // Your Rumble publisher ID for monetization

    // Core player functionality
    const initPlayer = async () => {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');
        
        if (!movieId) {
          throw new Error("Invalid movie ID");
        }

        // Update back button href with movieId
        const backButton = document.getElementById('back-button');
        if (backButton) {
          backButton.href = `see.html?id=${movieId}`;
        }

        // Show loading immediately
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        // Load movie data to get streaming link
        const movieData = await loadMovieData(movieId);
        const streamingLink = movieData.googleDriveLink || urlParams.get('streamingLink');
        if (!streamingLink) {
          throw new Error("No streaming link available for this movie");
        }

        // Initialize video player based on link type
        const videoContainer = document.getElementById('video-container');
        if (!videoContainer) {
          throw new Error("Video container not found");
        }
        
        if (streamingLink.includes('drive.google.com')) {
          // Google Drive player code remains the same
          const googleDriveMatch = streamingLink.match(/\/d\/(.+?)\//);
          if (!googleDriveMatch) throw new Error("Invalid Google Drive link format");
          videoContainer.innerHTML = `
            <iframe src="https://drive.google.com/file/d/${googleDriveMatch[1]}/preview" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; encrypted-media" 
                    allowfullscreen>
            </iframe>
          `;
          
          // Hide loading when Google Drive video loads
          const iframe = videoContainer.querySelector('iframe');
          if (iframe && loadingOverlay) {
            iframe.onload = () => {
              loadingOverlay.style.display = 'none';
            };
          }
        } else if (streamingLink.includes('rumble.com')) {
          // Extract Rumble video ID
          let videoId;
          const rumbleMatch = streamingLink.match(/(?:v|embed)\/?([a-zA-Z0-9]+)/);
          
          if (rumbleMatch && rumbleMatch[1]) {
            videoId = rumbleMatch[1]; // e.g., "6tg1dx" from "v6tg1dx" or "embed/v6tg1dx"
          } else {
            throw new Error("Invalid Rumble link format");
          }

          // Create container for Rumble player
          videoContainer.innerHTML = `<div id="rumble_${videoId}"></div>`;

          // Load Rumble embed script
          const script = document.createElement('script');
          script.src = `https://rumble.com/embedJS/${RUMBLE_PUB_ID}.${videoId}/?pub=${RUMBLE_PUB_ID}`;
          script.async = true;
          document.body.appendChild(script);

          // Initialize Rumble player
          window.Rumble = window.Rumble || function() {
            (window.Rumble._ = window.Rumble._ || []).push(arguments);
          };

          window.Rumble("play", {
            video: videoId,
            div: `rumble_${videoId}`,
            rel: 0 // Don't show related videos at the end
          });

          // Check for player initialization
          const checkPlayer = setInterval(() => {
            const player = document.querySelector(`#rumble_${videoId} iframe`);
            if (player) {
              clearInterval(checkPlayer);
              if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
              }
            }
          }, 500);

          // Fallback timeout
          setTimeout(() => {
            clearInterval(checkPlayer);
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
          }, 10000);
        } else {
          throw new Error("Unsupported streaming link type");
        }

        // Set page title
        document.title = `${movieData.title} | KINAFLIX`;
        
      } catch (error) {
        console.error('Player initialization error:', error);
        showError(error.message);
      }
    };

    // Load movie data from Firestore (same as before)
    const loadMovieData = async (movieId) => {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js');
      const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
      
      const app = initializeApp({
        apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
        authDomain: "kinaflix.firebaseapp.com",
        projectId: "kinaflix",
        storageBucket: "kinaflix.appspot.com",
        messagingSenderId: "318239806217",
        appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8"
      });
      
      const db = getFirestore(app);
      const docSnap = await getDoc(doc(db, 'movies', movieId));
      
      if (!docSnap.exists()) {
        throw new Error('Movie not found');
      }
      
      return docSnap.data();
    };

    // Error handling (same as before)
    const showError = (message) => {
      const container = document.getElementById('video-container');
      container.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;display:flex;flex-direction:column;justify-content:center;align-items:center;background:#000;color:#e50914;text-align:center;padding:2rem;z-index:100;">
          <h1 style="font-size:1.5rem;margin-bottom:1rem;">⚠️ Error</h1>
          <p style="margin-bottom:1.5rem;">${message}</p>
          <a href="index.html" style="background:#e50914;color:white;padding:0.5rem 1rem;border-radius:4px;text-decoration:none;">
            <span style="margin-right:0.5rem;"><i class="fas fa-arrow-left"></i></span>
            <span>Go Back</span>
          </a>
        </div>
      `;
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      document.title = `Error | KINAFLIX`;
    };

    // Initialize player when page loads
    if (document.readyState === 'complete') {
      initPlayer();
    } else {
      document.addEventListener('DOMContentLoaded', initPlayer);
    }
  </script>
</body>
</html>
