<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Loading... | KINAFLIX</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
  <style>
    :root {
      --primary: #e50914;
      --ad-primary: #4285f4;
      --dark: #000000;
      --light: #f5f5f5;
      --gray-text: #888;
    }

    body {
      margin: 0;
      padding: 0;
      background-color: var(--dark);
      color: var(--light);
      height: 100vh;
      overflow: hidden;
      font-family: system-ui, -apple-system, sans-serif;
    }

    .back-button {
      position: fixed;
      top: 20px;
      left: 20px;
      z-index: 100;
      background-color: var(--primary);
      color: white;
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .back-button:hover {
      background-color: #f40612;
    }

    .video-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #000;
    }

    .video-container iframe,
    .video-container div[id^="rumble_"] {
      width: 100%;
      height: 100%;
      border: none;
    }

    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 10;
      gap: 1rem;
    }

    .loading-spinner {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid var(--primary);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }

    .loading-text {
      color: white;
      font-size: 1rem;
    }

    .ad-notification {
      position: fixed;
      top: 20px;
      right: 20px;
      width: 300px;
      height: 50px;
      background: rgba(0, 0, 0, 0.8);
      border-left: 3px solid var(--ad-primary);
      display: flex;
      align-items: center;
      padding: 0 10px;
      z-index: 200;
      animation: slideIn 0.3s ease-out;
      overflow: hidden;
      cursor: pointer;
      border-radius: 4px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes slideIn {
      from { transform: translateX(100%); }
      to { transform: translateX(0); }
    }

    .ad-notification img {
      height: 40px;
      width: 40px;
      object-fit: cover;
      margin-right: 10px;
      border-radius: 4px;
    }

    .ad-notification-content {
      flex: 1;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ad-notification-title {
      font-size: 12px;
      font-weight: bold;
      color: white;
      margin-bottom: 2px;
    }

    .ad-notification-description {
      font-size: 10px;
      color: var(--gray-text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .ad-notification-close {
      background: none;
      border: none;
      color: white;
      cursor: pointer;
      margin-left: 5px;
    }

    .error-container {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      background: #000;
      color: #e50914;
      text-align: center;
      padding: 2rem;
      z-index: 100;
    }

    .error-title {
      font-size: 1.5rem;
      margin-bottom: 1rem;
    }

    .error-message {
      margin-bottom: 1.5rem;
      max-width: 80%;
    }

    .error-button {
      background: #e50914;
      color: white;
      padding: 0.5rem 1rem;
      border-radius: 25px;
      text-decoration: none;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.3s ease;
    }

    .error-button:hover {
      background: #f40612;
    }
  </style>
</head>
<body>
  <a href="#" class="back-button" id="back-button">
    <i class="fas fa-arrow-left"></i>
    <span>BACK</span>
  </a>

  <div class="video-container" id="video-container">
    <div class="loading-overlay" id="loading-overlay">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading player...</div>
    </div>
  </div>

  <script type="module">
    // Configuration
    const AD_DISPLAY_DURATION = 7000; // 7 seconds
    const INITIAL_AD_DELAY = 60000;   // 1 minute for first ad
    const AD_INTERVAL = 420000;       // 7 minutes for subsequent ads
    const RUMBLE_CHANNEL_ID = 'u4m9tqz'; // Your Rumble channel ID for monetization
    const RUMBLE_PUB_ID = '4m9tqz'; // Your Rumble publisher ID for monetization

    // Core player functionality
    const initPlayer = async () => {
      try {
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');
        
        if (!movieId) {
          throw new Error("Invalid movie ID");
        }

        // Update back button href with movieId
        const backButton = document.getElementById('back-button');
        if (backButton) {
          backButton.href = `see.html?id=${movieId}`;
        }

        // Show loading immediately
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        // Load movie data to get streaming link
        const movieData = await loadMovieData(movieId);
        const streamingLink = movieData.googleDriveLink || urlParams.get('streamingLink');
        if (!streamingLink) {
          throw new Error("No streaming link available for this movie");
        }

        // Initialize video player based on link type
        const videoContainer = document.getElementById('video-container');
        if (!videoContainer) {
          throw new Error("Video container not found");
        }
        
        if (streamingLink.includes('drive.google.com')) {
          const googleDriveMatch = streamingLink.match(/\/d\/(.+?)\//);
          if (!googleDriveMatch) throw new Error("Invalid Google Drive link format");
          videoContainer.innerHTML = `
            <iframe src="https://drive.google.com/file/d/${googleDriveMatch[1]}/preview" 
                    frameborder="0" 
                    allow="autoplay; fullscreen; encrypted-media" 
                    allowfullscreen>
            </iframe>
          `;
          
          // Hide loading when Google Drive video loads
          const iframe = videoContainer.querySelector('iframe');
          if (iframe && loadingOverlay) {
            iframe.onload = () => {
              loadingOverlay.style.display = 'none';
            };
          }
        } else if (streamingLink.includes('rumble.com')) {
          // Extract Rumble video ID (supports multiple URL formats)
          let videoId;
          const rumbleMatch1 = streamingLink.match(/v([a-zA-Z0-9]+)/);
          const rumbleMatch2 = streamingLink.match(/rumble\.com\/([a-zA-Z0-9]+)/);
          
          if (rumbleMatch1) {
            videoId = rumbleMatch1[0]; // e.g., v6tg1dx
          } else if (rumbleMatch2) {
            videoId = 'v' + rumbleMatch2[1]; // Convert to v-prefix format
          } else {
            throw new Error("Invalid Rumble link format");
          }

          const divId = `rumble_${videoId.replace('v', '')}`;
          videoContainer.innerHTML = `<div id="${divId}"></div>`;

          // Load Rumble embed script with monetization parameters
          !function(r,u,m,b,l,e){
            r._Rumble = b;
            r[b] || (r[b] = function(){
              (r[b]._ = r[b]._ || []).push(arguments);
              if (r[b]._.length == 1) {
                l = u.createElement(m),
                e = u.getElementsByTagName(m)[0],
                l.async = 1,
                l.src = "https://rumble.com/embedJS/" + RUMBLE_CHANNEL_ID + 
                        (arguments[1].video ? '.' + arguments[1].video : '') +
                        "/?pub=" + RUMBLE_PUB_ID + 
                        "&url=" + encodeURIComponent(location.href) +
                        "&args=" + encodeURIComponent(JSON.stringify([].slice.apply(arguments))),
                e.parentNode.insertBefore(l, e)
              }
            })
          }(window, document, "script", "Rumble");

          // Initialize Rumble player with monetization
          Rumble("play", {
            video: videoId.replace('v', ''),
            div: divId,
            params: {
              pub: RUMBLE_PUB_ID,
              autoplay: 2 // Autoplay with sound off
            }
          });

          // Check for Rumble player initialization
          const checkPlayerReady = setInterval(() => {
            const rumblePlayer = document.querySelector(`#${divId} iframe`);
            if (rumblePlayer) {
              clearInterval(checkPlayerReady);
              if (loadingOverlay) {
                loadingOverlay.style.display = 'none';
              }
            }
          }, 500);
          
          // Fallback timeout in case player doesn't load
          setTimeout(() => {
            clearInterval(checkPlayerReady);
            if (loadingOverlay) {
              loadingOverlay.style.display = 'none';
            }
          }, 10000);
        } else {
          throw new Error("Unsupported streaming link type");
        }

        // Load movie data to set page title
        document.title = `${movieData.title} | KINAFLIX`;
        
        // Initialize ad system after video starts loading
        initAdSystem();
        
      } catch (error) {
        showError(error.message);
      }
    };

    // Load movie data from Firestore
    const loadMovieData = async (movieId) => {
      const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js');
      const { getFirestore, doc, getDoc } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
      
      const app = initializeApp({
        apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
        authDomain: "kinaflix.firebaseapp.com",
        projectId: "kinaflix",
        storageBucket: "kinaflix.appspot.com",
        messagingSenderId: "318239806217",
        appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8"
      });
      
      const db = getFirestore(app);
      const docSnap = await getDoc(doc(db, 'movies', movieId));
      
      if (!docSnap.exists()) {
        throw new Error('Movie not found');
      }
      
      return docSnap.data();
    };

    // Ad management system
    const initAdSystem = async () => {
      try {
        const { initializeApp } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-app.js');
        const { getFirestore, collection, getDocs } = await import('https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js');
        
        const app = initializeApp({
          apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
          authDomain: "kinaflix.firebaseapp.com",
          projectId: "kinaflix",
          storageBucket: "kinaflix.appspot.com",
          messagingSenderId: "318239806217",
          appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8"
        });
        
        const db = getFirestore(app);
        const adsSnapshot = await getDocs(collection(db, 'ads'));
        const ads = adsSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }))
          .filter(ad => !ad.category || ad.category === 'Movie');
        
        if (ads.length > 0) {
          setTimeout(() => showRandomAd(ads), INITIAL_AD_DELAY);
          setInterval(() => showRandomAd(ads), AD_INTERVAL);
        }
      } catch (error) {
        console.error('Ad system error:', error);
      }
    };

    const showRandomAd = (ads) => {
      const ad = ads[Math.floor(Math.random() * ads.length)];
      const adElement = document.createElement('div');
      adElement.className = 'ad-notification';
      adElement.innerHTML = `
        <img src="${ad.imageUrl}" alt="${ad.name}" loading="lazy">
        <div class="ad-notification-content">
          <div class="ad-notification-title">${ad.name}</div>
          <div class="ad-notification-description">${ad.description}</div>
        </div>
        <button class="ad-notification-close"><i class="fas fa-times"></i></button>
      `;
      
      adElement.addEventListener('click', (e) => {
        if (!e.target.closest('.ad-notification-close')) {
          window.open(ad.link, '_blank');
        }
      });
      
      document.body.appendChild(adElement);
      
      setTimeout(() => {
        adElement.remove();
      }, AD_DISPLAY_DURATION);
      
      adElement.querySelector('.ad-notification-close').addEventListener('click', (e) => {
        e.stopPropagation();
        adElement.remove();
      });
    };

    const showError = (message) => {
      const container = document.getElementById('video-container');
      container.innerHTML = `
        <div class="error-container">
          <h1 class="error-title">⚠️ Error</h1>
          <p class="error-message">${message}</p>
          <a href="index.html" class="error-button">
            <i class="fas fa-arrow-left"></i>
            <span>Go Back</span>
          </a>
        </div>
      `;
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        loadingOverlay.style.display = 'none';
      }
      document.title = `Error | KINAFLIX`;
    };

    if (document.readyState === 'complete') {
      initPlayer();
    } else {
      document.addEventListener('DOMContentLoaded', initPlayer);
    }
  </script>
</body>
</html>
