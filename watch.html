<script type="module">
    // Configuration
    const RUMBLE_PUB_ID = '4m9tqz'; // Your monetized publisher ID
    const DEBUG_MODE = true; // Set to false in production

    // Debug logging (same as before)
    // Error handling (same as before)
    // Load movie data from Firestore (same as before)

    // Improved Rumble video ID extractor
    function extractRumbleVideoId(url) {
      try {
        debugLog(`Extracting video ID from: ${url}`);
        
        // Handle various Rumble URL formats:
        // 1. https://rumble.com/v6vmxmr-minacraft.html
        // 2. https://rumble.com/embed/v6vmxmr/
        // 3. https://rumble.com/v6vmxmr
        const patterns = [
          /rumble\.com\/(?:embed\/)?v([a-z0-9]+)/i,  // Matches vXXXXXX
          /rumble\.com\/([a-z0-9]+)(?:-|$)/i         // Matches XXXXXX directly
        ];
        
        for (const pattern of patterns) {
          const match = url.match(pattern);
          if (match && match[1]) {
            const videoId = match[1];
            debugLog(`Extracted video ID: ${videoId}`);
            return videoId;
          }
        }
        
        throw new Error("No video ID found in URL");
      } catch (error) {
        throw new Error(`Failed to extract Rumble video ID: ${error.message}`);
      }
    }

    // Initialize Rumble player (same as before)

    // Core player functionality
    const initPlayer = async () => {
      try {
        debugLog(`Initializing player...`);
        
        const urlParams = new URLSearchParams(window.location.search);
        const movieId = urlParams.get('movieId');
        
        if (!movieId) {
          throw new Error("Invalid movie ID");
        }

        // Update back button
        const backButton = document.getElementById('back-button');
        if (backButton) {
          backButton.href = `see.html?id=${movieId}`;
        }

        // Show loading
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.style.display = 'flex';
        }
        
        // Load movie data
        const movieData = await loadMovieData(movieId);
        const streamingLink = movieData.googleDriveLink || urlParams.get('streamingLink');
        
        if (!streamingLink) {
          throw new Error("No streaming link available for this movie");
        }

        debugLog(`Streaming link: ${streamingLink}`);
        
        // Extract video ID from Rumble URL
        const videoId = extractRumbleVideoId(streamingLink);
        debugLog(`Using Rumble video ID: ${videoId}`);

        // Initialize Rumble player
        const containerId = `rumble_${videoId}`;
        document.getElementById('video-container').innerHTML = `<div id="${containerId}"></div>`;
        
        await initRumblePlayer(videoId, containerId);
        
        // Hide loading overlay
        if (loadingOverlay) {
          loadingOverlay.style.display = 'none';
        }

        // Set page title
        document.title = `${movieData.title || 'Video'} | KINAFLIX`;
        
        debugLog(`Player initialized successfully`);
        
      } catch (error) {
        showError(`Failed to load video: ${error.message}`, error);
      }
    };

    // Initialize player when page loads
    if (document.readyState === 'complete') {
      initPlayer();
    } else {
      document.addEventListener('DOMContentLoaded', initPlayer);
    }
</script>
