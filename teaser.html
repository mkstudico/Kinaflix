<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Teasers | KINAFLIX</title>
  <meta name="description" content="Manage channels and short movies on KINAFLIX.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
  <style>
    :root {
      --primary: #e50914;
      --primary-dark: #b2070f;
      --dark: #141414;
      --light: #f4f4f4;
      --gray: #999;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      --sidebar-width: 80px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--dark);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border-right: 1px solid var(--primary);
    }
    .sidebar a, .sidebar button {
      color: var(--light);
      font-size: 1.5rem;
      margin: 1rem 0;
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s;
    }
    .sidebar a:hover, .sidebar button:hover {
      color: var(--primary);
    }
    .sidebar .active {
      color: var(--primary);
    }
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 2rem;
    }
    .container {
      background: var(--dark);
      padding: 1.5rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--primary);
      margin-bottom: 1.5rem;
    }
    .title {
      font-size: 1.5rem;
      color: var(--primary);
      margin-bottom: 1rem;
    }
    .form-section {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .form-section input,
    .form-section textarea,
    .form-section select {
      padding: 0.5rem;
      border: 1px solid var(--gray);
      border-radius: 4px;
      background: #222;
      color: var(--light);
      font-size: 0.9rem;
    }
    .form-section input[type="file"] {
      padding: 0.2rem;
    }
    .form-section button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.7rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.3s;
    }
    .form-section button:hover {
      background: var(--primary-dark);
    }
    .form-section button:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }
    .button-group {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 1rem;
    }
    .button-group button {
      flex: 1;
    }
    .channels-list {
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid var(--gray);
      border-radius: 4px;
      padding: 0.5rem;
    }
    .channel-item {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem;
      background: #222;
      margin-bottom: 0.5rem;
      border-radius: 4px;
    }
    .channel-item img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .channel-item span {
      flex: 1;
      font-size: 0.9rem;
    }
    .channel-item.selected {
      border: 1px solid var(--primary);
    }
    .search-bar {
      position: relative;
      margin-bottom: 1rem;
    }
    .search-bar input {
      width: 100%;
      padding: 0.5rem 2rem 0.5rem 1rem;
    }
    .search-bar i {
      position: absolute;
      right: 0.8rem;
      top: 50%;
      transform: translateY(-50%);
      color: var(--gray);
      font-size: 0.9rem;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--dark);
      padding: 1.5rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      position: relative;
      border: 1px solid var(--primary);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: var(--primary);
    }
    .modal-preview {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 1rem;
      display: block;
    }
    .confirmation-modal {
      text-align: center;
    }
    .confirmation-modal button {
      margin: 0.5rem;
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .loading-overlay.active {
      display: flex;
    }
    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 5px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner {
      display: none;
      width: 30px;
      height: 30px;
      margin: 1rem auto;
      border: 3px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner.active {
      display: block;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--dark);
      color: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success {
      background: #4CAF50;
    }
    .toast.error {
      background: #f44336;
    }
    .trailers-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: 1rem;
      margin-top: 1rem;
    }
    .trailer-card {
      cursor: pointer;
      transition: transform 0.3s;
    }
    .trailer-card:hover {
      transform: scale(1.05);
    }
    .trailer-poster {
      width: 100%;
      height: 100px;
      object-fit: cover;
      border-radius: 4px;
    }
    .trailer-title {
      font-size: 0.8rem;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: 60px;
        top: auto;
        bottom: 0;
        flex-direction: row;
        justify-content: space-around;
        border-right: none;
        border-top: 1px solid var(--primary);
      }
      .main-content {
        margin-left: 0;
        margin-bottom: 60px;
        padding: 1rem;
      }
      .container {
        padding: 1rem;
      }
      .trailers-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }
    @media (max-width: 576px) {
      .title {
        font-size: 1.2rem;
      }
      .form-section input,
      .form-section textarea,
      .form-section select,
      .form-section button {
        font-size: 0.85rem;
      }
      .trailers-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
      }
      .trailer-poster {
        height: 80px;
      }
      .trailer-title {
        font-size: 0.75rem;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="#" class="add-teaser active"><i class="fas fa-plus"></i></a>
    <a href="#" class="view-teasers"><i class="fas fa-video"></i></a>
  </div>
  <div class="main-content">
    <div class="container add-teaser-section">
      <h1 class="title">Add Teaser</h1>
      <div class="container">
        <h2 class="title">Channel</h2>
        <div class="form-section">
          <div class="button-group">
            <button id="add-channel-btn">Add New Channel</button>
            <button id="edit-channel-btn">Edit Channels</button>
          </div>
          <div class="search-bar">
            <input type="text" id="channel-search" placeholder="Search channels...">
            <i class="fas fa-search"></i>
          </div>
          <div class="channels-list" id="channels-list"></div>
        </div>
      </div>
      <div class="container">
        <h2 class="title">Short Movie</h2>
        <form id="movie-form" class="form-section">
          <input type="text" id="movie-title" placeholder="Movie Title" required>
          <input type="url" id="movie-gdrive" placeholder="Google Drive Link" required>
          <input type="file" id="movie-poster" accept="image/*">
          <textarea id="movie-description" placeholder="Description (Optional)" rows="4"></textarea>
          <button type="submit" id="add-movie-btn">Add Movie</button>
        </form>
        <div class="form-spinner" id="movie-spinner"></div>
      </div>
    </div>
    <div class="container view-teasers-section" style="display: none;">
      <h1 class="title">Short Movies</h1>
      <div class="search-bar">
        <input type="text" id="movie-search" placeholder="Search movies...">
        <i class="fas fa-search"></i>
      </div>
      <div class="trailers-grid" id="trailers-grid"></div>
      <div class="form-spinner" id="trailers-spinner"></div>
    </div>
  </div>
  <div class="modal" id="add-channel-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Add Channel</h2>
      <form id="add-channel-form" class="form-section">
        <input type="text" id="channel-name" placeholder="Channel Name" required>
        <input type="file" id="channel-image" accept="image/*" required>
        <img id="channel-preview" class="modal-preview" src="" alt="Preview" style="display: none;">
        <textarea id="channel-description" placeholder="Description" rows="4" required></textarea>
        <select id="channel-category" required>
          <option value="" disabled selected>Select Category</option>
          <option value="K-Drama">K-Drama Sh</option>
          <option value="Horror">Horror Sh</option>
          <option value="Adult">Adult</option>
          <option value="Sport">Sport</option>
          <option value="Education">Education</option>
          <option value="Romance">Movies</option>
          <option value="Facts">General knowledge</option>
          <option value="Facts">Trailers</option>
          <option value="Songs">Gaming</option>
          <option value="Songs">Trivia</option>
          <option value="Songs">Songs</option>
          <option value="Advertisement">Advertisement</option>
        </select>
        <button type="submit">Submit</button>
      </form>
      <div class="form-spinner" id="add-channel-spinner"></div>
    </div>
  </div>
  <div class="modal" id="edit-channel-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Edit Channels</h2>
      <div class="search-bar">
        <input type="text" id="edit-channel-search" placeholder="Search channels...">
        <i class="fas fa-search"></i>
      </div>
      <div class="channels-list" id="edit-channels-list"></div>
    </div>
  </div>
  <div class="modal" id="edit-movie-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Edit Movie</h2>
      <form id="edit-movie-form" class="form-section">
        <input type="hidden" id="edit-movie-id">
        <input type="text" id="edit-movie-title" placeholder="Movie Title" required>
        <input type="url" id="edit-movie-gdrive" placeholder="Google Drive Link" required>
        <input type="file" id="edit-movie-poster" accept="image/*">
        <textarea id="edit-movie-description" placeholder="Description (Optional)" rows="4"></textarea>
        <div class="search-bar">
          <input type="text" id="edit-movie-channel-search" placeholder="Search channels...">
          <i class="fas fa-search"></i>
        </div>
        <div class="channels-list" id="edit-movie-channels-list"></div>
        <button type="submit" id="edit-movie-btn">Update Movie</button>
        <button type="button" id="delete-movie-btn" style="background: #f44336;">Delete Movie</button>
      </form>
      <div class="form-spinner" id="edit-movie-spinner"></div>
    </div>
  </div>
  <div class="modal" id="edit-channel-details-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Edit Channel</h2>
      <form id="edit-channel-details-form" class="form-section">
        <input type="hidden" id="edit-channel-id">
        <input type="text" id="edit-channel-name" placeholder="Channel Name" required>
        <input type="file" id="edit-channel-image" accept="image/*">
        <img id="edit-channel-preview" class="modal-preview" src="" alt="Preview">
        <textarea id="edit-channel-description" placeholder="Description" rows="4" required></textarea>
        <select id="edit-channel-category" required>
          <option value="" disabled>Select Category</option>
          <option value="K-Drama">K-Drama</option>
          <option value="Horror">Horror</option>
          <option value="Adult">Adult</option>
          <option value="Sport">Sport</option>
          <option value="Education">Education</option>
          <option value="Adventure">Adventure</option>
          <option value="Action">Action</option>
          <option value="Sci-Fi">Sci-Fi</option>
          <option value="Indie">Indie</option>
          <option value="Romance">Romance</option>
          <option value="Facts">Facts</option>
          <option value="Advertisement">Advertisement</option>
          <option value="Songs">Songs</option>
          <option value="Thriller">Thriller</option>
        </select>
        <button type="submit">Update Channel</button>
        <button type="button" id="delete-channel-btn" style="background: #f44336;">Delete Channel</button>
      </form>
      <div class="form-spinner" id="edit-channel-spinner"></div>
    </div>
  </div>
  <div class="modal" id="confirm-delete-modal">
    <div class="modal-content confirmation-modal">
      <h2 class="title" id="confirm-title"></h2>
      <p id="confirm-message"></p>
      <button id="confirm-yes-btn" style="background: #f44336;">Yes</button>
      <button id="confirm-no-btn">No</button>
    </div>
  </div>
  <div class="modal" id="confirm-delete-again-modal">
    <div class="modal-content confirmation-modal">
      <h2 class="title">Confirm Again</h2>
      <p>Are you absolutely sure? This action cannot be undone.</p>
      <button id="confirm-again-yes-btn" style="background: #f44336;">Yes</button>
      <button id="confirm-again-no-btn">No</button>
    </div>
  </div>
  <div class="loading-overlay" id="initial-loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  <div class="toast" id="toast"></div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, deleteDoc, query, orderBy, where } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
      authDomain: "kinaflix.firebaseapp.com",
      databaseURL: "https://kinaflix-default-rtdb.firebaseio.com",
      projectId: "kinaflix",
      storageBucket: "kinaflix.firebasestorage.app",
      messagingSenderId: "318239806217",
      appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8",
      measurementId: "G-DC1T9B6B9W"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);

    const addTeaserSection = document.querySelector('.add-teaser-section');
    const viewTeasersSection = document.querySelector('.view-teasers-section');
    const addTeaserLink = document.querySelector('.add-teaser');
    const viewTeasersLink = document.querySelector('.view-teasers');
    const movieForm = document.getElementById('movie-form');
    const editMovieForm = document.getElementById('edit-movie-form');
    const addChannelForm = document.getElementById('add-channel-form');
    const editChannelDetailsForm = document.getElementById('edit-channel-details-form');
    const channelsList = document.getElementById('channels-list');
    const editChannelsList = document.getElementById('edit-channels-list');
    const editMovieChannelsList = document.getElementById('edit-movie-channels-list');
    const trailersGrid = document.getElementById('trailers-grid');
    const addChannelBtn = document.getElementById('add-channel-btn');
    const editChannelBtn = document.getElementById('edit-channel-btn');
    const channelSearch = document.getElementById('channel-search');
    const editChannelSearch = document.getElementById('edit-channel-search');
    const movieSearch = document.getElementById('movie-search');
    const editMovieChannelSearch = document.getElementById('edit-movie-channel-search');
    const addChannelModal = document.getElementById('add-channel-modal');
    const editChannelModal = document.getElementById('edit-channel-modal');
    const editMovieModal = document.getElementById('edit-movie-modal');
    const editChannelDetailsModal = document.getElementById('edit-channel-details-modal');
    const confirmDeleteModal = document.getElementById('confirm-delete-modal');
    const confirmDeleteAgainModal = document.getElementById('confirm-delete-again-modal');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const movieSpinner = document.getElementById('movie-spinner');
    const editMovieSpinner = document.getElementById('edit-movie-spinner');
    const addChannelSpinner = document.getElementById('add-channel-spinner');
    const editChannelSpinner = document.getElementById('edit-channel-spinner');
    const trailersSpinner = document.getElementById('trailers-spinner');
    const toast = document.getElementById('toast');
    let channels = [];
    let trailers = [];
    let selectedChannelId = null;
    let deleteTarget = null;
    let deleteType = null;

    document.addEventListener('DOMContentLoaded', () => {
      initialLoadingOverlay.classList.add('active');
      Promise.all([loadChannels(), loadTrailers()]).then(() => {
        initialLoadingOverlay.classList.remove('active');
      });

      addTeaserLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTeaserSection.style.display = 'block';
        viewTeasersSection.style.display = 'none';
        addTeaserLink.classList.add('active');
        viewTeasersLink.classList.remove('active');
      });

      viewTeasersLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTeaserSection.style.display = 'none';
        viewTeasersSection.style.display = 'block';
        addTeaserLink.classList.remove('active');
        viewTeasersLink.classList.add('active');
        loadTrailers();
      });

      addChannelBtn.addEventListener('click', () => {
        addChannelModal.style.display = 'flex';
      });

      editChannelBtn.addEventListener('click', () => {
        editChannelModal.style.display = 'flex';
        renderEditChannels(channels);
      });

      document.querySelectorAll('.modal-close').forEach(btn => {
        btn.addEventListener('click', () => {
          btn.closest('.modal').style.display = 'none';
        });
      });

      document.querySelectorAll('.modal').forEach(modal => {
        modal.addEventListener('click', (e) => {
          if (e.target === modal) modal.style.display = 'none';
        });
      });

      document.getElementById('channel-image').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const preview = document.getElementById('channel-preview');
          preview.src = URL.createObjectURL(file);
          preview.style.display = 'block';
        }
      });

      document.getElementById('edit-channel-image').addEventListener('change', (e) => {
        const file = e.target.files[0];
        if (file) {
          const preview = document.getElementById('edit-channel-preview');
          preview.src = URL.createObjectURL(file);
        }
      });

      let channelSearchTimeout;
      channelSearch.addEventListener('input', () => {
        clearTimeout(channelSearchTimeout);
        channelSearchTimeout = setTimeout(() => {
          const query = channelSearch.value.trim().toLowerCase();
          renderChannels(filterChannels(query));
        }, 300);
      });

      let editChannelSearchTimeout;
      editChannelSearch.addEventListener('input', () => {
        clearTimeout(editChannelSearchTimeout);
        editChannelSearchTimeout = setTimeout(() => {
          const query = editChannelSearch.value.trim().toLowerCase();
          renderEditChannels(filterChannels(query));
        }, 300);
      });

      let movieSearchTimeout;
      movieSearch.addEventListener('input', () => {
        clearTimeout(movieSearchTimeout);
        movieSearchTimeout = setTimeout(() => {
          const query = movieSearch.value.trim().toLowerCase();
          renderTrailers(filterTrailers(query));
        }, 300);
      });

      let editMovieChannelSearchTimeout;
      editMovieChannelSearch.addEventListener('input', () => {
        clearTimeout(editMovieChannelSearchTimeout);
        editMovieChannelSearchTimeout = setTimeout(() => {
          const query = editMovieChannelSearch.value.trim().toLowerCase();
          renderEditMovieChannels(filterChannels(query));
        }, 300);
      });

      addChannelForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('add-channel');
        try {
          const channelName = document.getElementById('channel-name').value.trim();
          const imageFile = document.getElementById('channel-image').files[0];
          const description = document.getElementById('channel-description').value.trim();
          const category = document.getElementById('channel-category').value;

          if (!channelName || !imageFile || !description || !category) {
            showToast('All fields are required', 'error');
            hideFormLoading('add-channel');
            return;
          }

          const formData = new FormData();
          formData.append('image', imageFile);
          const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
            method: 'POST',
            body: formData
          });
          const data = await response.json();
          if (!data.success) {
            showToast('Failed to upload channel image', 'error');
            hideFormLoading('add-channel');
            return;
          }

          await addDoc(collection(db, 'channels'), {
            channelName,
            imageUrl: data.data.url,
            description,
            category,
            createdAt: new Date()
          });

          showToast('Channel added successfully', 'success');
          addChannelForm.reset();
          document.getElementById('channel-preview').style.display = 'none';
          addChannelModal.style.display = 'none';
          await loadChannels();
        } catch (error) {
          console.error('Error adding channel:', error);
          showToast('Error adding channel: ' + error.message, 'error');
        } finally {
          hideFormLoading('add-channel');
        }
      });

      movieForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('movie');
        try {
          const title = document.getElementById('movie-title').value.trim();
          const gdriveLink = document.getElementById('movie-gdrive').value.trim();
          const description = document.getElementById('movie-description').value.trim();
          const posterFile = document.getElementById('movie-poster').files[0];

          if (!title || !gdriveLink || !selectedChannelId) {
            showToast('Title, Google Drive link, and channel are required', 'error');
            hideFormLoading('movie');
            return;
          }

          if (!gdriveLink.includes('drive.google.com')) {
            showToast('Please provide a valid Google Drive link', 'error');
            hideFormLoading('movie');
            return;
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (!data.success) {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('movie');
              return;
            }
            posterUrl = data.data.url;
          }

          await addDoc(collection(db, 'trailers'), {
            title,
            gdriveLink,
            posterUrl: posterUrl || 'https://via.placeholder.com/140x100?text=No+Image',
            description: description || '',
            channelId: selectedChannelId,
            createdAt: new Date()
          });

          showToast('Movie added successfully', 'success');
          movieForm.reset();
          selectedChannelId = null;
          channelsList.querySelectorAll('.channel-item').forEach(item => item.classList.remove('selected'));
          await loadTrailers();
        } catch (error) {
          console.error('Error adding movie:', error);
          showToast('Error adding movie: ' + error.message, 'error');
        } finally {
          hideFormLoading('movie');
        }
      });

      editChannelDetailsForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('edit-channel');
        try {
          const channelId = document.getElementById('edit-channel-id').value;
          const channelName = document.getElementById('edit-channel-name').value.trim();
          const description = document.getElementById('edit-channel-description').value.trim();
          const category = document.getElementById('edit-channel-category').value;
          const imageFile = document.getElementById('edit-channel-image').files[0];

          if (!channelName || !description || !category) {
            showToast('All fields are required', 'error');
            hideFormLoading('edit-channel');
            return;
          }

          let imageUrl = document.getElementById('edit-channel-preview').src;
          if (imageFile) {
            const formData = new FormData();
            formData.append('image', imageFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (!data.success) {
              showToast('Failed to upload channel image', 'error');
              hideFormLoading('edit-channel');
              return;
            }
            imageUrl = data.data.url;
          }

          const channelRef = doc(db, 'channels', channelId);
          await updateDoc(channelRef, {
            channelName,
            imageUrl,
            description,
            category,
            updatedAt: new Date()
          });

          showToast('Channel updated successfully', 'success');
          editChannelDetailsModal.style.display = 'none';
          await loadChannels();
        } catch (error) {
          console.error('Error updating channel:', error);
          showToast('Error updating channel: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit-channel');
        }
      });

      editMovieForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('edit-movie');
        try {
          const movieId = document.getElementById('edit-movie-id').value;
          const title = document.getElementById('edit-movie-title').value.trim();
          const gdriveLink = document.getElementById('edit-movie-gdrive').value.trim();
          const description = document.getElementById('edit-movie-description').value.trim();
          const posterFile = document.getElementById('edit-movie-poster').files[0];

          if (!title || !gdriveLink || !selectedChannelId) {
            showToast('Title, Google Drive link, and channel are required', 'error');
            hideFormLoading('edit-movie');
            return;
          }

          if (!gdriveLink.includes('drive.google.com')) {
            showToast('Please provide a valid Google Drive link', 'error');
            hideFormLoading('edit-movie');
            return;
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (!data.success) {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('edit-movie');
              return;
            }
            posterUrl = data.data.url;
          }

          const movieRef = doc(db, 'trailers', movieId);
          const updateData = {
            title,
            gdriveLink,
            description: description || '',
            channelId: selectedChannelId,
            updatedAt: new Date()
          };
          if (posterUrl) updateData.posterUrl = posterUrl;
          await updateDoc(movieRef, updateData);

          showToast('Movie updated successfully', 'success');
          editMovieModal.style.display = 'none';
          await loadTrailers();
        } catch (error) {
          console.error('Error updating movie:', error);
          showToast('Error updating movie: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit-movie');
        }
      });

      document.getElementById('delete-channel-btn').addEventListener('click', () => {
        const channelId = document.getElementById('edit-channel-id').value;
        deleteTarget = channelId;
        deleteType = 'channel';
        showConfirmDeleteModal('Delete Channel', 'Are you sure you want to delete this channel? All associated movies will also be deleted.');
      });

      document.getElementById('delete-movie-btn').addEventListener('click', () => {
        const movieId = document.getElementById('edit-movie-id').value;
        deleteTarget = movieId;
        deleteType = 'movie';
        showConfirmDeleteModal('Delete Movie', 'Are you sure you want to delete this movie?');
      });

      document.getElementById('confirm-yes-btn').addEventListener('click', () => {
        confirmDeleteModal.style.display = 'none';
        confirmDeleteAgainModal.style.display = 'flex';
      });

      document.getElementById('confirm-no-btn').addEventListener('click', () => {
        confirmDeleteModal.style.display = 'none';
        deleteTarget = null;
        deleteType = null;
      });

      document.getElementById('confirm-again-yes-btn').addEventListener('click', async () => {
        confirmDeleteAgainModal.style.display = 'none';
        showFormLoading('edit-channel');
        try {
          if (deleteType === 'channel') {
            const channelRef = doc(db, 'channels', deleteTarget);
            const moviesQuery = query(collection(db, 'trailers'), where('channelId', '==', deleteTarget));
            const moviesSnapshot = await getDocs(moviesQuery);
            for (const movieDoc of moviesSnapshot.docs) {
              await deleteDoc(doc(db, 'trailers', movieDoc.id));
            }
            await deleteDoc(channelRef);
            showToast('Channel and associated movies deleted', 'success');
            editChannelDetailsModal.style.display = 'none';
            await loadChannels();
            await loadTrailers();
          } else if (deleteType === 'movie') {
            const movieRef = doc(db, 'trailers', deleteTarget);
            await deleteDoc(movieRef);
            showToast('Movie deleted', 'success');
            editMovieModal.style.display = 'none';
            await loadTrailers();
          }
        } catch (error) {
          console.error('Error deleting:', error);
          showToast('Error deleting: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit-channel');
          deleteTarget = null;
          deleteType = null;
        }
      });

      document.getElementById('confirm-again-no-btn').addEventListener('click', () => {
        confirmDeleteAgainModal.style.display = 'none';
        deleteTarget = null;
        deleteType = null;
      });

      channelsList.addEventListener('click', (e) => {
        const channelItem = e.target.closest('.channel-item');
        if (channelItem) {
          selectedChannelId = channelItem.dataset.id;
          channelsList.querySelectorAll('.channel-item').forEach(item => item.classList.remove('selected'));
          channelItem.classList.add('selected');
        }
      });

      editMovieChannelsList.addEventListener('click', (e) => {
        const channelItem = e.target.closest('.channel-item');
        if (channelItem) {
          selectedChannelId = channelItem.dataset.id;
          editMovieChannelsList.querySelectorAll('.channel-item').forEach(item => item.classList.remove('selected'));
          channelItem.classList.add('selected');
        }
      });

      editChannelsList.addEventListener('click', (e) => {
        const editBtn = e.target.closest('.edit-channel');
        if (editBtn) {
          const channelId = editBtn.dataset.id;
          const channel = channels.find(c => c.id === channelId);
          document.getElementById('edit-channel-id').value = channelId;
          document.getElementById('edit-channel-name').value = channel.channelName;
          document.getElementById('edit-channel-description').value = channel.description;
          document.getElementById('edit-channel-category').value = channel.category;
          document.getElementById('edit-channel-preview').src = channel.imageUrl;
          editChannelModal.style.display = 'none';
          editChannelDetailsModal.style.display = 'flex';
        }
      });

      trailersGrid.addEventListener('click', (e) => {
        const trailerCard = e.target.closest('.trailer-card');
        if (trailerCard) {
          const trailerId = trailerCard.dataset.id;
          const trailer = trailers.find(t => t.id === trailerId);
          document.getElementById('edit-movie-id').value = trailerId;
          document.getElementById('edit-movie-title').value = trailer.title;
          document.getElementById('edit-movie-gdrive').value = trailer.gdriveLink;
          document.getElementById('edit-movie-description').value = trailer.description || '';
          selectedChannelId = trailer.channelId;
          renderEditMovieChannels(channels);
          editMovieChannelsList.querySelector(`[data-id="${trailer.channelId}"]`)?.classList.add('selected');
          editMovieModal.style.display = 'flex';
        }
      });
    });

    async function loadChannels() {
      try {
        const q = query(collection(db, 'channels'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        channels = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderChannels(channels.slice(0, 5));
        renderEditChannels(channels);
      } catch (error) {
        console.error('Error loading channels:', error);
        showToast('Error loading channels: ' + error.message, 'error');
      }
    }

    async function loadTrailers() {
      showFormLoading('trailers');
      try {
        const q = query(collection(db, 'trailers'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        trailers = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderTrailers(trailers);
      } catch (error) {
        console.error('Error loading trailers:', error);
        showToast('Error loading trailers: ' + error.message, 'error');
      } finally {
        hideFormLoading('trailers');
      }
    }

    function renderChannels(channelsToRender) {
      channelsList.innerHTML = channelsToRender.length > 0 ? channelsToRender.map(channel => `
        <div class="channel-item ${selectedChannelId === channel.id ? 'selected' : ''}" data-id="${channel.id}">
          <img src="${channel.imageUrl}" alt="${channel.channelName}">
          <span>${channel.channelName} (${channel.category})</span>
        </div>
      `).join('') : '<p>No channels found.</p>';
    }

    function renderEditChannels(channelsToRender) {
      editChannelsList.innerHTML = channelsToRender.length > 0 ? channelsToRender.map(channel => `
        <div class="channel-item">
          <img src="${channel.imageUrl}" alt="${channel.channelName}">
          <span>${channel.channelName} (${channel.category})</span>
          <button class="edit-channel" data-id="${channel.id}"><i class="fas fa-edit"></i></button>
        </div>
      `).join('') : '<p>No channels found.</p>';
    }

    function renderEditMovieChannels(channelsToRender) {
      editMovieChannelsList.innerHTML = channelsToRender.length > 0 ? channelsToRender.map(channel => `
        <div class="channel-item ${selectedChannelId === channel.id ? 'selected' : ''}" data-id="${channel.id}">
          <img src="${channel.imageUrl}" alt="${channel.channelName}">
          <span>${channel.channelName} (${channel.category})</span>
        </div>
      `).join('') : '<p>No channels found.</p>';
    }

    function renderTrailers(trailersToRender) {
      trailersGrid.innerHTML = trailersToRender.length > 0 ? trailersToRender.map(trailer => `
        <div class="trailer-card" data-id="${trailer.id}">
          <img src="${trailer.posterUrl}" alt="${trailer.title}" class="trailer-poster" loading="lazy">
          <h3 class="trailer-title">${trailer.title}</h3>
        </div>
      `).join('') : '<p>No movies found.</p>';
    }

    function filterChannels(query) {
      if (!query) return channels;
      return channels.filter(channel => 
        channel.channelName.toLowerCase().includes(query) || 
        channel.category.toLowerCase().includes(query) || 
        channel.description.toLowerCase().includes(query)
      );
    }

    function filterTrailers(query) {
      if (!query) return trailers;
      return trailers.filter(trailer => {
        const descriptionMatch = trailer.description?.toLowerCase().includes(query);
        const titleMatch = trailer.title.toLowerCase().includes(query);
        return descriptionMatch || titleMatch;
      }).sort((a, b) => {
        const aDescriptionMatch = a.description?.toLowerCase().includes(query) ? 1 : 0;
        const bDescriptionMatch = b.description?.toLowerCase().includes(query) ? 1 : 0;
        return bDescriptionMatch - aDescriptionMatch;
      });
    }

    function showConfirmDeleteModal(title, message) {
      document.getElementById('confirm-title').textContent = title;
      document.getElementById('confirm-message').textContent = message;
      confirmDeleteModal.style.display = 'flex';
    }

    function showToast(message, type = 'info') {
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showFormLoading(formType) {
      if (formType === 'movie') {
        movieSpinner.classList.add('active');
        document.getElementById('add-movie-btn').disabled = true;
        movieForm.style.opacity = '0.6';
      } else if (formType === 'edit-movie') {
        editMovieSpinner.classList.add('active');
        document.getElementById('edit-movie-btn').disabled = true;
        editMovieForm.style.opacity = '0.6';
      } else if (formType === 'add-channel') {
        addChannelSpinner.classList.add('active');
        addChannelForm.querySelector('button').disabled = true;
        addChannelForm.style.opacity = '0.6';
      } else if (formType === 'edit-channel') {
        editChannelSpinner.classList.add('active');
        editChannelDetailsForm.querySelector('button').disabled = true;
        editChannelDetailsForm.style.opacity = '0.6';
      } else if (formType === 'trailers') {
        trailersSpinner.classList.add('active');
        trailersGrid.style.opacity = '0.6';
      }
    }

    function hideFormLoading(formType) {
      if (formType === 'movie') {
        movieSpinner.classList.remove('active');
        document.getElementById('add-movie-btn').disabled = false;
        movieForm.style.opacity = '1';
      } else if (formType === 'edit-movie') {
        editMovieSpinner.classList.remove('active');
        document.getElementById('edit-movie-btn').disabled = false;
        editMovieForm.style.opacity = '1';
      } else if (formType === 'add-channel') {
        addChannelSpinner.classList.remove('active');
        addChannelForm.querySelector('button').disabled = false;
        addChannelForm.style.opacity = '1';
      } else if (formType === 'edit-channel') {
        editChannelSpinner.classList.remove('active');
        editChannelDetailsForm.querySelector('button').disabled = false;
        editChannelDetailsForm.style.opacity = '1';
      } else if (formType === 'trailers') {
        trailersSpinner.classList.remove('active');
        trailersGrid.style.opacity = '1';
      }
    }
  </script>
</body>
</html>
