<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Add Trailers | KINAFLIX</title>
  <meta name="description" content="Add and edit movie trailers on KINAFLIX.">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" media="print" onload="this.media='all'">
  <style>
    :root {
      --primary: #e50914;
      --primary-dark: #b2070f;
      --dark: #141414;
      --light: #f4f4f4;
      --gray: #999;
      --shadow: 0 4px 15px rgba(0, 0, 0, 0.5);
      --sidebar-width: 80px;
    }
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    body {
      font-family: 'Segoe UI', sans-serif;
      background: var(--dark);
      color: var(--light);
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: var(--sidebar-width);
      background: var(--dark);
      height: 100vh;
      position: fixed;
      left: 0;
      top: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 1rem;
      border-right: 1px solid var(--primary);
    }
    .sidebar a, .sidebar button {
      color: var(--light);
      font-size: 1.5rem;
      margin: 1rem 0;
      text-decoration: none;
      background: none;
      border: none;
      cursor: pointer;
      transition: color 0.3s;
    }
    .sidebar a:hover, .sidebar button:hover {
      color: var(--primary);
    }
    .sidebar .active {
      color: var(--primary);
    }
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      padding: 2rem;
    }
    .container {
      max-width: 500px;
      width: 100%;
      background: var(--dark);
      padding: 2rem;
      border-radius: 8px;
      box-shadow: var(--shadow);
      border: 1px solid var(--primary);
      margin-bottom: 2rem;
    }
    .title {
      font-size: 1.8rem;
      color: var(--primary);
      text-align: center;
      margin-bottom: 1.5rem;
    }
    .trailer-form {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .trailer-form input,
    .trailer-form textarea,
    .trailer-form select {
      padding: 0.5rem;
      border: 1px solid var(--gray);
      border-radius: 4px;
      background: #222;
      color: var(--light);
      font-size: 1rem;
    }
    .trailer-form input[type="file"] {
      padding: 0.2rem;
    }
    .trailer-form select {
      padding: 0.5rem;
    }
    .trailer-form button {
      background: var(--primary);
      color: white;
      border: none;
      padding: 0.8rem;
      border-radius: 4px;
      cursor: pointer;
      font-size: 1rem;
      transition: background 0.3s;
    }
    .trailer-form button:hover {
      background: var(--primary-dark);
    }
    .trailer-form button:disabled {
      background: var(--gray);
      cursor: not-allowed;
    }
    .trailer-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 1rem;
      margin-top: 2rem;
    }
    .trailer-card {
      background: #222;
      border-radius: 8px;
      overflow: hidden;
      transition: transform 0.3s;
      cursor: pointer;
    }
    .trailer-card:hover {
      transform: translateY(-5px);
    }
    .trailer-poster {
      width: 100%;
      height: 120px;
      object-fit: cover;
    }
    .trailer-info {
      padding: 0.5rem;
    }
    .trailer-title {
      font-size: 0.9rem;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background: var(--dark);
      padding: 2rem;
      border-radius: 8px;
      max-width: 500px;
      width: 90%;
      position: relative;
      border: 1px solid var(--primary);
    }
    .modal-close {
      position: absolute;
      top: 10px;
      right: 10px;
      background: none;
      border: none;
      color: var(--light);
      font-size: 1.5rem;
      cursor: pointer;
    }
    .modal-close:hover {
      color: var(--primary);
    }
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.9);
      z-index: 2000;
      justify-content: center;
      align-items: center;
    }
    .loading-overlay.active {
      display: flex;
    }
    .loading-spinner {
      width: 60px;
      height: 60px;
      border: 6px solid rgba(255, 255, 255, 0.2);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner {
      display: none;
      width: 40px;
      height: 40px;
      margin: 1rem auto;
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-radius: 50%;
      border-top-color: var(--primary);
      animation: spin 1s ease-in-out infinite;
    }
    .form-spinner.active {
      display: block;
    }
    .toast {
      position: fixed;
      bottom: 20px;
      right: 20px;
      background: var(--dark);
      color: white;
      padding: 1rem;
      border-radius: 4px;
      box-shadow: var(--shadow);
      transform: translateY(100px);
      opacity: 0;
      transition: all 0.3s;
      z-index: 1000;
    }
    .toast.show {
      transform: translateY(0);
      opacity: 1;
    }
    .toast.success {
      background: #4CAF50;
    }
    .toast.error {
      background: #f44336;
    }
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @media (max-width: 768px) {
      .sidebar {
        width: 100%;
        height: 60px;
        top: auto;
        bottom: 0;
        flex-direction: row;
        justify-content: space-around;
        border-right: none;
        border-top: 1px solid var(--primary);
      }
      .main-content {
        margin-left: 0;
        margin-bottom: 60px;
      }
      .container {
        padding: 1rem;
      }
      .trailer-grid {
        grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
      }
      .trailer-poster {
        height: 100px;
      }
      .trailer-title {
        font-size: 0.85rem;
      }
    }
    @media (max-width: 576px) {
      .title {
        font-size: 1.5rem;
      }
      .trailer-form input,
      .trailer-form textarea,
      .trailer-form select,
      .trailer-form button {
        font-size: 0.9rem;
      }
      .trailer-grid {
        grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      }
      .trailer-poster {
        height: 90px;
      }
      .trailer-title {
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <a href="#" class="add-trailer active"><i class="fas fa-plus"></i></a>
    <a href="#" class="view-trailers"><i class="fas fa-video"></i></a>
  </div>
  <div class="main-content">
    <div class="container add-trailer-section">
      <h1 class="title">Add Trailer</h1>
      <form id="trailer-form" class="trailer-form">
        <input type="text" id="trailer-title" placeholder="Trailer Title" required>
        <input type="url" id="trailer-video-url" placeholder="YouTube Video URL" required>
        <input type="file" id="trailer-poster" accept="image/*">
        <textarea id="trailer-description" placeholder="Description (Optional)" rows="4"></textarea>
        <select id="trailer-genre" required>
          <option value="" disabled selected>Select Genre</option>
          <option value="Action">Action</option>
          <option value="Horror">Horror</option>
          <option value="Mystery">Mystery</option>
          <option value="Sport">Sport</option>
          <option value="Adult">Adult</option>
          <option value="Adventure">Adventure</option>
          <option value="KDrama">KDrama</option>
          <option value="Indie">Indie</option>
        </select>
        <input type="number" id="trailer-year" placeholder="Year (e.g., 2025)" min="1900" max="2100">
        <button type="submit" id="add-trailer-btn">Add Trailer</button>
      </form>
      <div class="form-spinner" id="add-loading-spinner"></div>
    </div>
    <div class="container view-trailers-section" style="display: none;">
      <h1 class="title">Trailers</h1>
      <div class="trailer-grid" id="trailer-grid"></div>
      <div class="form-spinner" id="trailers-loading-spinner"></div>
    </div>
  </div>
  <div class="modal" id="edit-modal">
    <div class="modal-content">
      <button class="modal-close"><i class="fas fa-times"></i></button>
      <h2 class="title">Edit Trailer</h2>
      <form id="edit-trailer-form" class="trailer-form">
        <input type="hidden" id="edit-trailer-id">
        <input type="text" id="edit-trailer-title" placeholder="Trailer Title" required>
        <input type="url" id="edit-trailer-video-url" placeholder="YouTube Video URL" required>
        <input type="file" id="edit-trailer-poster" accept="image/*">
        <textarea id="edit-trailer-description" placeholder="Description (Optional)" rows="4"></textarea>
        <select id="edit-trailer-genre" required>
          <option value="" disabled selected>Select Genre</option>
          <option value="Action">Action</option>
          <option value="Horror">Horror</option>
          <option value="Mystery">Mystery</option>
          <option value="Sport">Sport</option>
          <option value="Adult">Adult</option>
          <option value="Adventure">Adventure</option>
          <option value="KDrama">KDrama</option>
          <option value="Indie">Indie</option>
        </select>
        <input type="number" id="edit-trailer-year" placeholder="Year (e.g., 2025)" min="1900" max="2100">
        <button type="submit" id="edit-trailer-btn">Update Trailer</button>
      </form>
      <div class="form-spinner" id="edit-loading-spinner"></div>
    </div>
  </div>
  <div class="loading-overlay" id="initial-loading-overlay">
    <div class="loading-spinner"></div>
  </div>
  <div class="toast" id="toast"></div>
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-analytics.js";
    import { getFirestore, collection, addDoc, getDocs, updateDoc, doc, query, orderBy } from "https://www.gstatic.com/firebasejs/12.0.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCBrRTdhrRTRL9ZfZpb-m-1XBmbDIsXF9k",
      authDomain: "kinaflix.firebaseapp.com",
      databaseURL: "https://kinaflix-default-rtdb.firebaseio.com",
      projectId: "kinaflix",
      storageBucket: "kinaflix.firebasestorage.app",
      messagingSenderId: "318239806217",
      appId: "1:318239806217:web:ee98bd97cd2a08ac3239d8",
      measurementId: "G-DC1T9B6B9W"
    };

    const app = initializeApp(firebaseConfig);
    getAnalytics(app);
    const db = getFirestore(app);

    const trailerForm = document.getElementById('trailer-form');
    const editTrailerForm = document.getElementById('edit-trailer-form');
    const trailerGrid = document.getElementById('trailer-grid');
    const addTrailerSection = document.querySelector('.add-trailer-section');
    const viewTrailersSection = document.querySelector('.view-trailers-section');
    const addTrailerLink = document.querySelector('.add-trailer');
    const viewTrailersLink = document.querySelector('.view-trailers');
    const editModal = document.getElementById('edit-modal');
    const modalClose = document.querySelector('.modal-close');
    const addLoadingSpinner = document.getElementById('add-loading-spinner');
    const editLoadingSpinner = document.getElementById('edit-loading-spinner');
    const trailersLoadingSpinner = document.getElementById('trailers-loading-spinner');
    const initialLoadingOverlay = document.getElementById('initial-loading-overlay');
    const addTrailerBtn = document.getElementById('add-trailer-btn');
    const editTrailerBtn = document.getElementById('edit-trailer-btn');
    const toast = document.getElementById('toast');

    document.addEventListener('DOMContentLoaded', () => {
      addTrailerLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTrailerSection.style.display = 'block';
        viewTrailersSection.style.display = 'none';
        addTrailerLink.classList.add('active');
        viewTrailersLink.classList.remove('active');
      });

      viewTrailersLink.addEventListener('click', (e) => {
        e.preventDefault();
        addTrailerSection.style.display = 'none';
        viewTrailersSection.style.display = 'block';
        addTrailerLink.classList.remove('active');
        viewTrailersLink.classList.add('active');
        loadTrailers();
      });

      trailerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('add');
        try {
          const title = document.getElementById('trailer-title').value.trim();
          const videoUrl = document.getElementById('trailer-video-url').value.trim();
          const description = document.getElementById('trailer-description').value.trim();
          const posterFile = document.getElementById('trailer-poster').files[0];
          const genre = document.getElementById('trailer-genre').value;
          const year = document.getElementById('trailer-year').value.trim();

          if (!title || !videoUrl || !genre) {
            showToast('Title, YouTube URL, and genre are required', 'error');
            hideFormLoading('add');
            return;
          }

          if (!videoUrl.includes('youtube.com') && !videoUrl.includes('youtu.be')) {
            showToast('Please provide a valid YouTube URL', 'error');
            hideFormLoading('add');
            return;
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (data.success) {
              posterUrl = data.data.url;
            } else {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('add');
              return;
            }
          }

          await addDoc(collection(db, 'trailers'), {
            title,
            videoUrl,
            posterUrl: posterUrl || 'https://via.placeholder.com/200x120?text=No+Image',
            description: description || '',
            genre,
            year: year || '',
            createdAt: new Date()
          });

          showToast('Trailer added successfully', 'success');
          trailerForm.reset();
        } catch (error) {
          console.error('Error adding trailer:', error);
          showToast('Error adding trailer: ' + error.message, 'error');
        } finally {
          hideFormLoading('add');
        }
      });

      editTrailerForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        showFormLoading('edit');
        try {
          const trailerId = document.getElementById('edit-trailer-id').value;
          const title = document.getElementById('edit-trailer-title').value.trim();
          const videoUrl = document.getElementById('edit-trailer-video-url').value.trim();
          const description = document.getElementById('edit-trailer-description').value.trim();
          const posterFile = document.getElementById('edit-trailer-poster').files[0];
          const genre = document.getElementById('edit-trailer-genre').value;
          const year = document.getElementById('edit-trailer-year').value.trim();

          if (!title || !videoUrl || !genre) {
            showToast('Title, YouTube URL, and genre are required', 'error');
            hideFormLoading('edit');
            return;
          }

          if (!videoUrl.includes('youtube.com') && !videoUrl.includes('youtu.be')) {
            showToast('Please provide a valid YouTube URL', 'error');
            hideFormLoading('edit');
            return;
          }

          let posterUrl = '';
          if (posterFile) {
            const formData = new FormData();
            formData.append('image', posterFile);
            const response = await fetch('https://api.imgbb.com/1/upload?key=82d2010a938dfd0a780ff9e6c71e68a7', {
              method: 'POST',
              body: formData
            });
            const data = await response.json();
            if (data.success) {
              posterUrl = data.data.url;
            } else {
              showToast('Failed to upload poster image', 'error');
              hideFormLoading('edit');
              return;
            }
          }

          const trailerRef = doc(db, 'trailers', trailerId);
          const updateData = {
            title,
            videoUrl,
            description: description || '',
            genre,
            year: year || '',
            updatedAt: new Date()
          };
          if (posterUrl) updateData.posterUrl = posterUrl;
          await updateDoc(trailerRef, updateData);

          showToast('Trailer updated successfully', 'success');
          editModal.style.display = 'none';
          loadTrailers();
        } catch (error) {
          console.error('Error updating trailer:', error);
          showToast('Error updating trailer: ' + error.message, 'error');
        } finally {
          hideFormLoading('edit');
        }
      });

      trailerGrid.addEventListener('click', (e) => {
        const trailerCard = e.target.closest('.trailer-card');
        if (trailerCard) {
          const trailerId = trailerCard.dataset.id;
          const trailer = trailerCard.dataset;
          document.getElementById('edit-trailer-id').value = trailerId;
          document.getElementById('edit-trailer-title').value = trailer.title;
          document.getElementById('edit-trailer-video-url').value = trailer.videoUrl;
          document.getElementById('edit-trailer-description').value = trailer.description;
          document.getElementById('edit-trailer-genre').value = trailer.genre;
          document.getElementById('edit-trailer-year').value = trailer.year;
          editModal.style.display = 'flex';
        }
      });

      modalClose.addEventListener('click', () => {
        editModal.style.display = 'none';
      });

      editModal.addEventListener('click', (e) => {
        if (e.target === editModal) {
          editModal.style.display = 'none';
        }
      });

      // Show initial loading overlay on page load
      initialLoadingOverlay.classList.add('active');
      setTimeout(() => {
        initialLoadingOverlay.classList.remove('active');
      }, 1000); // Simulate initial load; adjust as needed
    });

    async function loadTrailers() {
      showTrailersLoading();
      try {
        const q = query(collection(db, 'trailers'), orderBy('createdAt', 'desc'));
        const querySnapshot = await getDocs(q);
        const trailers = querySnapshot.docs.map(doc => ({
          id: doc.id,
          ...doc.data()
        }));
        renderTrailers(trailers);
      } catch (error) {
        console.error('Error loading trailers:', error);
        showToast('Error loading trailers: ' + error.message, 'error');
      } finally {
        hideTrailersLoading();
      }
    }

    function renderTrailers(trailers) {
      trailerGrid.innerHTML = trailers.length > 0 ? trailers.map(trailer => `
        <div class="trailer-card" 
             data-id="${trailer.id}" 
             data-title="${trailer.title}" 
             data-video-url="${trailer.videoUrl}" 
             data-description="${trailer.description || ''}" 
             data-genre="${trailer.genre}" 
             data-year="${trailer.year || ''}">
          <img src="${trailer.posterUrl || 'https://via.placeholder.com/200x120?text=No+Image'}" alt="${trailer.title}" class="trailer-poster" loading="lazy">
          <div class="trailer-info">
            <h3 class="trailer-title">${trailer.title}</h3>
          </div>
        </div>
      `).join('') : '<p>No trailers available.</p>';
    }

    function showToast(message, type = 'info') {
      toast.textContent = message;
      toast.className = 'toast';
      toast.classList.add(type, 'show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    function showFormLoading(formType) {
      if (formType === 'add') {
        addLoadingSpinner.classList.add('active');
        addTrailerBtn.disabled = true;
        trailerForm.style.opacity = '0.6';
      } else if (formType === 'edit') {
        editLoadingSpinner.classList.add('active');
        editTrailerBtn.disabled = true;
        editTrailerForm.style.opacity = '0.6';
      }
    }

    function hideFormLoading(formType) {
      if (formType === 'add') {
        addLoadingSpinner.classList.remove('active');
        addTrailerBtn.disabled = false;
        trailerForm.style.opacity = '1';
      } else if (formType === 'edit') {
        editLoadingSpinner.classList.remove('active');
        editTrailerBtn.disabled = false;
        editTrailerForm.style.opacity = '1';
      }
    }

    function showTrailersLoading() {
      trailersLoadingSpinner.classList.add('active');
      trailerGrid.style.opacity = '0.6';
    }

    function hideTrailersLoading() {
      trailersLoadingSpinner.classList.remove('active');
      trailerGrid.style.opacity = '1';
    }
  </script>
</body>
</html>
